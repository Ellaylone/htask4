"use strict";function Modal(t){this.element=t,this.status=!1}function ModalAlert(t){Modal.apply(this,arguments),this.contentEl=this.element.querySelector(".alert__content"),this.closeEl=this.element.querySelector(".close"),this.closeEl.addEventListener("click",this.hide.bind(this),!1)}function showPlayer(){linksEl.classList.add("hidden"),playerEl.classList.remove("hidden")}function initCanvas(){canvasStartState(),canvas.addEventListener("click",function(t){var e=t.pageX-t.target.offsetLeft,o=t.pageY-t.target.offsetTop;controlElements.some(function(t){e<t.right&&e>t.left&&o>t.top&&o<t.bottom&&onCanvasClick(t.type)})},!1)}function onCanvasClick(t){"start"==t?(isSubtitleShown?(drawSub(subtitles[subtitleIndex]),startSubTimeout()):video.play(),audio.play(),createPauseElement()):(isSubtitleShown?(drawSub(subtitles[subtitleIndex]),stopSubTimeout()):(video.pause(),stopDrawLoop(),drawCenterPlayButton(canvasControlsColor)),audio.pause(),controlElements=[],createStartElement())}function createStartElement(){controlElements=[{type:"start",top:0,left:0,right:canvas.width,bottom:canvas.height}]}function createPauseElement(){controlElements=[{type:"pause",top:0,left:0,right:canvas.width,bottom:canvas.height}]}function canvasResize(){var t=void 0,e=void 0;window.screen.width<window.screen.height?(t=window.screen.width>videoWidth?videoWidth:window.screen.width,e=t/videoSizeRatio):(e=window.screen.height>videoHeight?videoHeight:window.screen.height,t=e*videoSizeRatio),canvas.width=t,canvas.height=e}function canvasStartState(){canvasResize(),drawBackground(canvasBgColor),drawCenterPlayButton(canvasControlsColor)}function grayAndGrain(t){for(var e=t.data,o=void 0,i=0;i<e.length;i+=4){o=Math.random()+1;var n=e[i],a=e[i+1],s=e[i+2],r=.2126*n+.7152*a+.0722*s;e[i]=e[i+1]=e[i+2]=r*o}return t}function drawBackground(t){ctx.fillStyle=t,ctx.fillRect(0,0,canvas.width,canvas.height)}function drawCenterPlayButton(t){ctx.fillStyle=""+t;var e={width:35,height:50};e.points={top:{x:(canvas.width-e.width)/2,y:(canvas.height-e.height)/2},bottom:{x:(canvas.width-e.width)/2,y:(canvas.height+e.height)/2},right:{x:(canvas.width+e.width)/2,y:canvas.height/2}},controlElements.push({type:"start",top:e.points.top.y,left:e.points.top.x,bottom:e.points.bottom.y,right:e.points.right.x}),ctx.beginPath(),ctx.moveTo(e.points.top.x,e.points.top.y),ctx.lineTo(e.points.bottom.x,e.points.bottom.y),ctx.lineTo(e.points.right.x,e.points.right.y),ctx.fill()}function drawSkratches(){var t=Math.random()*(.8-.2);ctx.strokeStyle="rgba(255, 255, 255, "+t+")";var e=Math.floor(101*Math.random());if(e-=98,e>0)for(var o=0;o<e;o++)skratch()}function skratch(){ctx.beginPath();var t={x:Math.floor(Math.random()*canvas.width),y:Math.floor(Math.random()*canvas.height)},e={x:Math.floor(Math.random()*canvas.height),y:Math.floor(Math.random()*canvas.height)};ctx.moveTo(t.x,t.y),ctx.lineTo(e.x,e.y),ctx.stroke()}function startDrawLoop(){loopId||isSubtitleShown?"undefined"!=typeof subtitles[subtitleIndex]&&(subTimeout=setTimeout(hideSub,subtitles[subtitleIndex].timeLength/2)):loopId=setInterval(drawLoop,fps)}function stopDrawLoop(){loopId&&(clearInterval(loopId),loopId=void 0)}function drawLoop(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(video,0,0,canvas.width,canvas.height);var t=ctx.getImageData(0,0,canvas.width,canvas.height),e=grayAndGrain(t);ctx.putImageData(e,0,0),drawSkratches()}function _onInputFocus(t){t.target.setSelectionRange(0,t.target.value.length)}function _onLinksFormSubmit(t){t.preventDefault(),overlay.show(),loader.show();var e=document.querySelectorAll(".links-form__input"),o=!0;e.forEach(function(t){""===t.value&&(o=!1)}),o?Promise.all([createVideo(videoInput.value),createAudio(audioInput.value),createSub(subInput.value)]).then(function(t){initCanvas(),showPlayer(),subtitles=parseSrt(t[2]),loader.hide(),overlay.hide()})["catch"](function(t){loader.hide(),modalAlert.show("<h4>Error:</h4>"+t)}):(loader.hide(),overlay.hide())}function createSub(t){return new Promise(function(e,o){try{!function(){var o=new XMLHttpRequest;o.addEventListener("readystatechange",function(t){4===o.readyState&&200===o.status&&e(o.responseText)}),o.open("GET",t,!1),o.send()}()}catch(i){o(i)}})}function createVideo(t){return new Promise(function(e,o){try{video=document.createElement("video"),video.setAttribute("crossorigin","anonymous"),video.setAttribute("preload",!0),video.src=corsProxy+t,video.defaultMuted=!0,video.style.visibility="hidden",video.addEventListener("play",startDrawLoop,!1),video.addEventListener("pause",stopDrawLoop,!1),video.addEventListener("timeupdate",function(t){var e=(1e3*t.target.currentTime).toFixed();"undefined"!=typeof subtitles[subtitleIndex]&&e>=subtitles[subtitleIndex].endTime&&(isSubtitleShown||(showSub(subtitles[subtitleIndex]),startSubTimeout()))}),video.addEventListener("ended",function(t){audio.pause(),stopDrawLoop()},!1),video.addEventListener("loadeddata",function(t){document.querySelector("body").appendChild(video),videoSizeRatio=video.videoWidth/video.videoHeight,videoWidth=parseInt(getComputedStyle(video).width).toFixed(),videoHeight=videoWidth/videoSizeRatio,video.classList.add("player__video"),video.style.display="none",e(video)},!1)}catch(i){o(i)}})}function createAudio(t){return new Promise(function(e,o){try{audio=document.createElement("audio"),audio.setAttribute("crossorigin","anonymous"),audio.src=corsProxy+t,audio.autoplay=!1,audio.classList.add("player__audio"),audio.addEventListener("loadeddata",function(t){document.querySelector(".hidden-elements").appendChild(audio),e(audio)})}catch(i){o(i)}})}function parseSrt(t){var e={sec:1e3,min:60,hr:60},o=t.split("\n\n"),i=o.map(function(t){var o={},i=t.split("\n");o.number=parseInt(i[0]);var n=i[1].split(" --> "),a=n[0].split(":"),s=parseInt(a[2].split(",").join("")),r=parseInt(a[1])*e.min*e.sec,d=parseInt(a[0])*e.hr*e.min*e.sec;a=s+r+d,o.startTime=a;var l=n[1].split(":"),c=parseInt(l[2].split(",").join("")),u=parseInt(l[1])*e.min*e.sec,h=parseInt(l[0])*e.hr*e.min*e.sec;return l=c+u+h,o.endTime=l,o.timeLength=l-a,i.splice(0,2),o.content=i,new Subtitle(o)});return i}function Subtitle(t){this.startTime=t.startTime,this.endTime=t.endTime,this.content=t.content,this.timeLength=t.timeLength}function showSub(t){isSubtitleShown=!0,video.pause(),drawSub(t)}function drawSub(t){ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="white",ctx.font=canvasFontSize+"px Oranienbaum, serif";var e=t.content.length*canvasFontSize+(t.content.length-1)*canvasLineHeight,o=(canvas.height-e)/2;t.content.forEach(function(t,e){var i=o+canvasFontSize*e+canvasLineHeight*e,n=.1*canvas.width;ctx.fillText(t,n,i)})}function hideSub(){isSubtitleShown&&(isSubtitleShown=!1,subtitleIndex++,video.play()),clearTimeout(subTimeout),subTimeout=void 0,controlElements=[],createPauseElement()}function stopSubTimeout(){subTimeout&&(clearTimeout(subTimeout),subTimeout=void 0)}function startSubTimeout(){subTimeout=setTimeout(hideSub,subtitles[subtitleIndex].timeLength)}window.addEventListener("load",function(t){setTimeout(function(){loader.hide(),overlay.hide()},2e3)}),window.addEventListener("resize",function(t){loopId&&onCanvasClick("pause"),canvasStartState()},!1),Modal.prototype.hide=function(){this.element.classList.add("hidden"),this.status=!1},Modal.prototype.show=function(){this.element.classList.remove("hidden"),this.status=!0},Modal.prototype.toggle=function(){this.element.classList.toggle("hidden"),this.element.classList.contains("hidden")?this.status=!1:this.status=!0},ModalAlert.prototype=Object.create(Modal.prototype),ModalAlert.prototype.constructor=ModalAlert,ModalAlert.prototype.show=function(t){this.setContent(t),Modal.prototype.show.apply(this,arguments)},ModalAlert.prototype.setContent=function(t){this.contentEl.innerHTML=t};var canvasBgColor="#000",canvasControlsColor="#fff",canvasFontColor="#fff",canvasFontSize=24,canvasLineHeight=12,linksForm=document.querySelector(".links-form"),linksEl=document.querySelector(".links"),playerEl=document.querySelector(".player"),submitEl=document.querySelector(".links-form__submit"),linksFormInputs=document.querySelectorAll(".links-form__input"),videoInput=document.querySelector(".links-form__video"),audioInput=document.querySelector(".links-form__audio"),subInput=document.querySelector(".links-form__sub"),fps=1e3/60,video=void 0,canvas=void 0,audio=void 0;canvas=document.querySelector(".player__canvas");var controlElements=[],reader=new FileReader,srt=void 0,videoWidth=void 0,videoHeight=void 0,videoSizeRatio=void 0,isSubtitleShown=!1,subtitles=void 0,subTimeout=void 0,subtitleIndex=0,ctx=canvas.getContext("2d"),loopId=void 0,loaderStatus=!1,loader=new Modal(document.querySelector(".loader-wrap")),overlay=new Modal(document.querySelector(".overlay")),modalAlert=new ModalAlert(document.querySelector(".alert"));overlay.element.addEventListener("click",function(t){modalAlert.status&&(modalAlert.hide(),overlay.hide())},!1);var corsProxy="http://cors.io/?u=";linksForm.addEventListener("submit",_onLinksFormSubmit,!1),linksFormInputs.forEach(function(t){t.addEventListener("focus",_onInputFocus,!1)});
//# sourceMappingURL=main.js.map
